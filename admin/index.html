<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Back-office — Anim'PA 35</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f4f5f7; color: #1a1a2e; }

    .topbar { background: #1a1a2e; color: #fff; padding: 16px 24px; display: flex; align-items: center; gap: 12px; position: sticky; top: 0; z-index: 100; }
    .topbar h1 { font-size: 18px; font-weight: 700; }
    .topbar .dot { width: 8px; height: 8px; border-radius: 50%; background: #4CAF50; }
    .topbar .status { font-size: 13px; color: rgba(255,255,255,.6); margin-left: auto; }

    .container { max-width: 700px; margin: 0 auto; padding: 24px 16px; }

    /* New post form */
    .card { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.08); padding: 24px; margin-bottom: 20px; }
    .card h2 { font-size: 16px; font-weight: 700; margin-bottom: 16px; color: #1a1a2e; }

    label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 6px; }
    textarea { width: 100%; border: 1px solid #ddd; border-radius: 8px; padding: 12px; font-size: 14px; font-family: inherit; resize: vertical; min-height: 100px; transition: border-color .2s; }
    textarea:focus { outline: none; border-color: #E8711A; }
    input[type="date"] { border: 1px solid #ddd; border-radius: 8px; padding: 10px 12px; font-size: 14px; font-family: inherit; }
    input[type="date"]:focus { outline: none; border-color: #E8711A; }
    input[type="file"] { font-size: 13px; }

    .row { display: flex; gap: 16px; align-items: flex-end; margin-top: 12px; flex-wrap: wrap; }
    .row > div { flex: 1; min-width: 140px; }

    .file-area { margin-top: 12px; border: 2px dashed #ddd; border-radius: 8px; padding: 16px; text-align: center; cursor: pointer; transition: border-color .2s, background .2s; }
    .file-area:hover { border-color: #E8711A; background: #fef7f0; }
    .file-area p { font-size: 13px; color: #888; }
    .file-area .selected { margin-top: 8px; font-size: 12px; color: #E8711A; font-weight: 600; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 20px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: background .2s, transform .1s; }
    .btn:active { transform: scale(.97); }
    .btn-primary { background: #E8711A; color: #fff; }
    .btn-primary:hover { background: #C85E10; }
    .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
    .btn-danger { background: #fff; color: #e53e3e; border: 1px solid #e53e3e; padding: 6px 14px; font-size: 13px; }
    .btn-danger:hover { background: #fff5f5; }
    .btn-edit { background: #fff; color: #E8711A; border: 1px solid #E8711A; padding: 6px 14px; font-size: 13px; }
    .btn-edit:hover { background: #fef7f0; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }

    .submit-row { margin-top: 16px; display: flex; align-items: center; gap: 12px; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; background: #1a1a2e; color: #fff; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 500; opacity: 0; transform: translateY(10px); transition: all .3s; z-index: 200; }
    .toast.show { opacity: 1; transform: translateY(0); }
    .toast.error { background: #e53e3e; }
    .toast.success { background: #38a169; }

    /* Posts list */
    .post-item { background: #fff; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,.08); padding: 20px 24px; margin-bottom: 12px; }
    .post-item .post-date { font-size: 12px; color: #999; margin-bottom: 6px; }
    .post-item .post-content { font-size: 14px; line-height: 1.5; white-space: pre-line; }
    .post-item .post-media { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .post-item .post-media img, .post-item .post-media video { height: 80px; border-radius: 6px; object-fit: cover; }
    .post-item .post-actions { display: flex; gap: 8px; margin-top: 12px; }

    /* Edit form inside post */
    .edit-form { margin-top: 12px; padding-top: 12px; border-top: 1px solid #eee; }
    .edit-form textarea { min-height: 80px; }
    .edit-form .media-list { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .edit-form .media-thumb { position: relative; }
    .edit-form .media-thumb img, .edit-form .media-thumb video { height: 70px; border-radius: 6px; object-fit: cover; }
    .edit-form .media-remove { position: absolute; top: -6px; right: -6px; width: 20px; height: 20px; border-radius: 50%; background: #e53e3e; color: #fff; border: none; font-size: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    .spinner { width: 16px; height: 16px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animation: spin .6s linear infinite; display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty { text-align: center; color: #999; padding: 40px; font-size: 14px; }
  </style>
</head>
<body>

<div class="topbar">
  <div class="dot"></div>
  <h1>Back-office Anim'PA 35</h1>
  <span class="status" id="statusText">Prêt</span>
</div>

<div class="container">
  <!-- New post form -->
  <div class="card">
    <h2>Nouvelle actualité</h2>
    <div>
      <label for="newContent">Contenu</label>
      <textarea id="newContent" placeholder="Écrivez votre actualité ici…"></textarea>
    </div>
    <div class="row">
      <div>
        <label for="newDate">Date</label>
        <input type="date" id="newDate" />
      </div>
    </div>
    <div class="file-area" id="fileArea" onclick="document.getElementById('newFiles').click()">
      <p>Cliquez ou glissez des photos / vidéos ici</p>
      <div class="selected" id="fileLabel"></div>
      <input type="file" id="newFiles" multiple accept="image/*,video/*" hidden />
    </div>
    <div class="submit-row">
      <button class="btn btn-primary" id="btnPublish" onclick="createPost()">
        Publier
      </button>
      <span id="publishStatus" style="font-size:13px;color:#888;"></span>
    </div>
  </div>

  <!-- Posts list -->
  <h2 style="font-size:16px;font-weight:700;margin-bottom:12px;">Actualités existantes</h2>
  <div id="postsList"></div>
</div>

<div class="toast" id="toast"></div>

<script>
  // Set default date to today
  document.getElementById('newDate').valueAsDate = new Date()

  // File input label
  const fileInput = document.getElementById('newFiles')
  fileInput.addEventListener('change', () => {
    const n = fileInput.files.length
    document.getElementById('fileLabel').textContent = n > 0 ? `${n} fichier${n > 1 ? 's' : ''} sélectionné${n > 1 ? 's' : ''}` : ''
  })

  // Drag and drop
  const fileArea = document.getElementById('fileArea')
  fileArea.addEventListener('dragover', (e) => { e.preventDefault(); fileArea.style.borderColor = '#E8711A'; fileArea.style.background = '#fef7f0' })
  fileArea.addEventListener('dragleave', () => { fileArea.style.borderColor = '#ddd'; fileArea.style.background = '' })
  fileArea.addEventListener('drop', (e) => {
    e.preventDefault()
    fileArea.style.borderColor = '#ddd'
    fileArea.style.background = ''
    fileInput.files = e.dataTransfer.files
    fileInput.dispatchEvent(new Event('change'))
  })

  function toast(msg, type = 'success') {
    const el = document.getElementById('toast')
    el.textContent = msg
    el.className = 'toast show ' + type
    setTimeout(() => el.className = 'toast', 3000)
  }

  function setStatus(text) {
    document.getElementById('statusText').textContent = text
  }

  // ---- Load posts ----
  async function loadPosts() {
    const res = await fetch('/api/posts')
    const posts = await res.json()
    const list = document.getElementById('postsList')

    if (posts.length === 0) {
      list.innerHTML = '<div class="empty">Aucune actualité pour le moment.</div>'
      return
    }

    list.innerHTML = posts.map((p, i) => `
      <div class="post-item" id="post-${i}">
        <div class="post-date">${formatDate(p.date)}</div>
        <div class="post-content">${escapeHtml(p.content)}</div>
        ${p.media && p.media.length > 0 ? `
          <div class="post-media">
            ${p.media.map(m => m.type === 'video'
              ? `<video src="/preview-images/${m.url.split('/').pop()}" controls style="height:80px;border-radius:6px;"></video>`
              : `<img src="/preview-images/${m.url.split('/').pop()}" />`
            ).join('')}
          </div>
        ` : ''}
        <div class="post-actions">
          <button class="btn btn-edit" onclick="toggleEdit(${i})">Modifier</button>
          <button class="btn btn-danger" onclick="deletePost(${i})">Supprimer</button>
        </div>
        <div class="edit-form" id="edit-${i}" style="display:none;">
          <label>Contenu</label>
          <textarea id="editContent-${i}">${escapeHtml(p.content)}</textarea>
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="editDate-${i}" value="${p.date}" />
            </div>
          </div>
          ${p.media && p.media.length > 0 ? `
            <label style="margin-top:10px;">Médias actuels</label>
            <div class="media-list" id="mediaList-${i}">
              ${p.media.map((m, mi) => `
                <div class="media-thumb">
                  ${m.type === 'video'
                    ? `<video src="/preview-images/${m.url.split('/').pop()}" style="height:70px;border-radius:6px;"></video>`
                    : `<img src="/preview-images/${m.url.split('/').pop()}" />`}
                  <button class="media-remove" onclick="markRemoveMedia(${i}, ${mi})" title="Supprimer">×</button>
                </div>
              `).join('')}
            </div>
          ` : ''}
          <div style="margin-top:10px;">
            <label>Ajouter des médias</label>
            <input type="file" id="editFiles-${i}" multiple accept="image/*,video/*" />
          </div>
          <div style="margin-top:12px;display:flex;gap:8px;">
            <button class="btn btn-primary btn-sm" onclick="saveEdit(${i})">Enregistrer</button>
            <button class="btn btn-edit btn-sm" onclick="toggleEdit(${i})">Annuler</button>
          </div>
        </div>
      </div>
    `).join('')
  }

  // Track media removals per post during editing
  const mediaRemovals = {}

  function toggleEdit(idx) {
    const el = document.getElementById('edit-' + idx)
    el.style.display = el.style.display === 'none' ? 'block' : 'none'
    mediaRemovals[idx] = []
  }

  function markRemoveMedia(postIdx, mediaIdx) {
    if (!mediaRemovals[postIdx]) mediaRemovals[postIdx] = []
    // Get the media URL from the current data
    fetch('/api/posts').then(r => r.json()).then(posts => {
      const url = posts[postIdx].media[mediaIdx]?.url
      if (url && !mediaRemovals[postIdx].includes(url)) {
        mediaRemovals[postIdx].push(url)
        // Visually hide it
        const list = document.getElementById('mediaList-' + postIdx)
        if (list && list.children[mediaIdx]) {
          list.children[mediaIdx].style.opacity = '0.3'
          list.children[mediaIdx].style.pointerEvents = 'none'
        }
      }
    })
  }

  // ---- Create post ----
  async function createPost() {
    const content = document.getElementById('newContent').value.trim()
    if (!content) { toast('Le contenu est obligatoire', 'error'); return }

    const btn = document.getElementById('btnPublish')
    btn.disabled = true
    btn.innerHTML = '<span class="spinner"></span> Publication…'
    setStatus('Publication en cours…')

    const fd = new FormData()
    fd.append('content', content)
    fd.append('date', document.getElementById('newDate').value)
    for (const f of fileInput.files) fd.append('files', f)

    try {
      const res = await fetch('/api/posts', { method: 'POST', body: fd })
      const data = await res.json()
      if (data.git?.ok) {
        toast('Actualité publiée et mise en ligne !')
        setStatus('Publié !')
      } else {
        toast('Enregistré localement (push échoué : ' + (data.git?.error || '?') + ')', 'error')
        setStatus('Erreur push')
      }
      // Reset form
      document.getElementById('newContent').value = ''
      document.getElementById('newDate').valueAsDate = new Date()
      fileInput.value = ''
      document.getElementById('fileLabel').textContent = ''
      loadPosts()
    } catch (e) {
      toast('Erreur : ' + e.message, 'error')
      setStatus('Erreur')
    }
    btn.disabled = false
    btn.innerHTML = 'Publier'
  }

  // ---- Save edit ----
  async function saveEdit(idx) {
    const content = document.getElementById('editContent-' + idx).value.trim()
    if (!content) { toast('Le contenu est obligatoire', 'error'); return }

    setStatus('Modification en cours…')

    const fd = new FormData()
    fd.append('content', content)
    fd.append('date', document.getElementById('editDate-' + idx).value)

    const editFiles = document.getElementById('editFiles-' + idx)
    if (editFiles.files) {
      for (const f of editFiles.files) fd.append('files', f)
    }

    if (mediaRemovals[idx] && mediaRemovals[idx].length > 0) {
      fd.append('removeMedia', JSON.stringify(mediaRemovals[idx]))
    }

    try {
      const res = await fetch('/api/posts/' + idx, { method: 'PUT', body: fd })
      const data = await res.json()
      if (data.git?.ok) {
        toast('Actualité modifiée et mise en ligne !')
        setStatus('Publié !')
      } else {
        toast('Enregistré localement (push échoué)', 'error')
        setStatus('Erreur push')
      }
      loadPosts()
    } catch (e) {
      toast('Erreur : ' + e.message, 'error')
      setStatus('Erreur')
    }
  }

  // ---- Delete post ----
  async function deletePost(idx) {
    if (!confirm('Supprimer cette actualité ?')) return

    setStatus('Suppression en cours…')
    try {
      const res = await fetch('/api/posts/' + idx, { method: 'DELETE' })
      const data = await res.json()
      if (data.git?.ok) {
        toast('Actualité supprimée et mise en ligne !')
        setStatus('Publié !')
      } else {
        toast('Supprimé localement (push échoué)', 'error')
        setStatus('Erreur push')
      }
      loadPosts()
    } catch (e) {
      toast('Erreur : ' + e.message, 'error')
      setStatus('Erreur')
    }
  }

  // ---- Helpers ----
  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;')
  }

  function formatDate(str) {
    return new Date(str + 'T00:00:00').toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })
  }

  // Initial load
  loadPosts()
</script>
</body>
</html>
